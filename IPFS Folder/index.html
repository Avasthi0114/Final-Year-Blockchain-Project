<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPFS File Upload and Retrieval</title>
</head>
<body>
    <h1>Upload a File to IPFS</h1>
    <form id="uploadForm">
        <input type="file" id="fileInput" name="file" required>
        <button type="submit">Upload</button>
    </form>           
    <!-- <form id="uploadForm">
        <input type="file" id="fileInput" multiple />
        <button type="submit">Upload</button>
    </form>
    <div id="uploadResponse"></div> -->
    

    <div id="uploadResponse"></div>

    <h1>Retrieve a File from IPFS</h1>
    <form id="retrieveForm">
        <label for="cidInput">Enter File CID</label>
        <input type="text" id="cidInput" name="cid" required>
        <button type="submit">Retrieve</button>
    </form>

    <div id="retrieveResponse"></div>

    
    

    <h1>Create an IPFS Folder</h1>
    <form id="createFolderForm" enctype="multipart/form-data">
        <input type="file" id="folderInput" name="files" multiple required>
        <button type="submit">Create Folder</button>
    </form>

    <div id="folderResponse"></div>

    <h1>Retrieve an IPFS Folder</h1>
    <form id="retrieveFolderForm">
        <label for="folderCIDInput">Enter Folder CID:</label>
        <input type="text" id="folderCIDInput" name="folderCID" required>
        <button type="submit">Retrieve Folder</button>
    </form>

    <div id="retrieveFolderResponse"></div>

    <script>
        //Handle file upload
        document.getElementById('uploadForm').addEventListener('submit', async (event) => {
            event.preventDefault(); // Prevent default form submission
            const fileInput = document.getElementById('fileInput');
            const formData = new FormData();
            formData.append('file', fileInput.files[0]); // Add the selected file to FormData

            try {
                const response = await fetch('http://localhost:4300/upload', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                document.getElementById('uploadResponse').innerText = `File added to IPFS with hash: ${result.hash}`;
            } catch (error) {
                console.error('Error uploading file:', error);
                document.getElementById('uploadResponse').innerText = 'Error uploading file.';
            }
        });

    //     document.getElementById('uploadForm').addEventListener('submit', async (event) => {
    //     event.preventDefault();
    //     const files = document.getElementById('fileInput').files;
    //     const formData = new FormData();

    //     for (const file of files) {
    //         formData.append('files', file);
    //     }

    //     try {
    //         const response = await fetch('http://localhost:4300/createFolder', {
    //             method: 'POST',
    //             body: formData,
    //         });

    //         const result = await response.json();
    //         document.getElementById('uploadResponse').innerText = `Folder CID: ${result.folderCID}\nFile CIDs: ${JSON.stringify(result.fileCIDs, null, 2)}`;
    //     } catch (error) {
    //         console.error('Error uploading folder:', error);
    //         document.getElementById('uploadResponse').innerText = 'Error uploading folder.';
    //     }
    // });


        

       // Handle file retrieval by CID
        document.getElementById('retrieveForm').addEventListener('submit', async (event) => {
            event.preventDefault(); // Prevent default form submission
            const cidInput = document.getElementById('cidInput').value;

            try {
                const response = await fetch('http://localhost:4300/getFile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ evidenceCID: cidInput })
                });

                const result = await response.json();

                // Decode base64 and create a downloadable file link
                const fileBuffer = atob(result.fileBuffer); // Decode the base64
                const byteArray = new Uint8Array(fileBuffer.length);

                // Fill the byteArray with the binary data
                for (let i = 0; i < fileBuffer.length; i++) {
                    byteArray[i] = fileBuffer.charCodeAt(i);
                }

                // Create a Blob from the byteArray
                const blob = new Blob([byteArray]);
                const url = URL.createObjectURL(blob);

                // Create a download link with password protection
                const link = document.createElement('a');
                link.href = url;
                link.download = cidInput; // Set the CID as the filename
                link.innerText = "Download File";

                // Attach an event listener to prompt for a password before downloading
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const password = prompt("Enter password to download the file:");

                    // Check the password (this is just a simple check for demonstration)
                    const correctPassword = "12345"; // You can replace this with actual password validation logic

                    if (password === correctPassword) {
                        // If the password is correct, allow the download
                        window.location.href = link.href;
                    } else {
                        alert("Incorrect password. Access denied.");
                    }
                });

                document.getElementById('retrieveResponse').appendChild(link);

            } catch (error) {
                console.error('Error retrieving file:', error);
                document.getElementById('retrieveResponse').innerText = 'Error retrieving file.';
            }
        });

        


        document.getElementById('createFolderForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            const formData = new FormData();
            const folderInput = document.getElementById('folderInput');

            for (const file of folderInput.files) {
                formData.append('files', file);
            }

            try {
                const response = await fetch('http://localhost:4300/createFolder', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                document.getElementById('folderResponse').innerText = `Folder CID: ${result.folderCID}`;
            } catch (error) {
                console.error('Error creating folder:', error);
                document.getElementById('folderResponse').innerText = 'Error creating folder.';
            }
        });

        // Handle folder retrieval
        // document.getElementById('retrieveFolderForm').addEventListener('submit', async (event) => {
        //     event.preventDefault();
        //     const folderCID = document.getElementById('folderCIDInput').value;

        //     try {
        //         const response = await fetch('http://localhost:4300/getFolder', {
        //             method: 'POST',
        //             headers: { 'Content-Type': 'application/json' },
        //             body: JSON.stringify({ folderCID })
        //         });
        //         const files = await response.json();
        //         const output = files.map(file => `${file.name}: ${file.content}`).join('\n');
        //         document.getElementById('retrieveFolderResponse').innerText = `Files:\n${output}`;
        //     } catch (error) {
        //         console.error('Error retrieving folder:', error);
        //         document.getElementById('retrieveFolderResponse').innerText = 'Error retrieving folder.';
        //     }
        // });

        document.getElementById('retrieveFolderForm').addEventListener('submit', async (event) => {
        event.preventDefault();
        const folderCID = document.getElementById('folderCIDInput').value;

        try {
            const response = await fetch('http://localhost:4300/getFolder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ folderCID }),
            });

            if (!response.ok) {
                throw new Error('Failed to retrieve folder.');
            }

            // Create a Blob for the zip file
            const blob = await response.blob();
            const url = URL.createObjectURL(blob);

            // Create a download link with password protection
            const link = document.createElement('a');
            link.href = url;
            link.download = `${folderCID}.zip`;
            link.innerText = "Download Folder";

            link.addEventListener('click', (e) => {
                e.preventDefault();
                const password = prompt("Enter password to download the folder:");

                const correctPassword = "12345"; // Replace with actual validation logic

                if (password === correctPassword) {
                    window.location.href = link.href;
                } else {
                    alert("Incorrect password. Access denied.");
                }
            });

            document.getElementById('retrieveFolderResponse').appendChild(link);

        } catch (error) {
            console.error('Error retrieving folder:', error);
            document.getElementById('retrieveFolderResponse').innerText = 'Error retrieving folder.';
        }
});


    </script>
</body>
</html>
